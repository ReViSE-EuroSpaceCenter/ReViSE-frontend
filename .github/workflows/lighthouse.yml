name: Lighthouse CI

on:
  workflow_run:
    workflows: ["Run Jest Tests"]
    types: [completed]

  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  lighthouse-ci:
    if: >
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
      || (github.event_name == 'pull_request')

    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      #- name: Wait for Netlify Preview URL
      #  uses: jakepartusch/wait-for-netlify-action@v1.4
      #  id: netlify
      #  with:
      #    site_name: revise-frontend.netlify.app
      #    max_timeout: 300

      - name: Set test URL
        id: test_url
        run: |
          echo "url=https://example.com" >> $GITHUB_OUTPUT

      - name: Run Lighthouse CI (Mobile)
        id: lhci_mobile
        uses: treosh/lighthouse-ci-action@v12
        with:
          #urls: ${{ steps.netlify.outputs.url }}
          urls: ${{ steps.test_url.outputs.url }}
          uploadArtifacts: true
          artifactName: lhci-mobile
          configPath: ./lhci.mobile.json

      - name: Run Lighthouse CI (Desktop)
        id: lhci_desktop
        uses: treosh/lighthouse-ci-action@v12
        with:
          #urls: ${{ steps.netlify.outputs.url }}
          urls: ${{ steps.test_url.outputs.url }}
          uploadArtifacts: true
          artifactName: lhci-desktop
          configPath: ./lhci.desktop.json

      - name: Comment on PR with Lighthouse results
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const previewUrl = "${{ steps.test_url.outputs.url }}".replace(/\/$/, "");
    
            const manifestMobile = JSON.parse(`${{ steps.lhci_mobile.outputs.manifest }}`);
            const manifestDesktop = JSON.parse(`${{ steps.lhci_desktop.outputs.manifest }}`);
    
            const pct = v => Math.round(v * 100);
            const color = score => score >= 90 ? "ðŸŸ¢" : score >= 50 ? "ðŸŸ " : "ðŸ”´";
    
            function rowsFromManifest(manifest, label) {
              let rows = `### ${label}\n\n`;
              rows += `| URL | Perf | A11y | Best Practices | SEO |\n`;
              rows += `| --- | ---- | ---- | -------------- | --- |\n`;
    
              for (const entry of manifest) {
                const url = entry.url;
                const s = entry.summary;
    
                const perf = pct(s.performance);
                const a11y = pct(s.accessibility);
                const bp = pct(s["best-practices"]);
                const seo = pct(s.seo);
    
                const path = url.replace(previewUrl, "") || "/";
                rows += `| ${path} | ${color(perf)} ${perf} | ${color(a11y)} ${a11y} | ${color(bp)} ${bp} | ${color(seo)} ${seo} |\n`;
              }
              return rows + "\n";
            }
    
            let body = `## ðŸš¦ Lighthouse Results\n`;
            body += `Preview URL: ${previewUrl}\n\n`;
            body += rowsFromManifest(manifestMobile, "ðŸ“± Mobile");
            body += rowsFromManifest(manifestDesktop, "ðŸ–¥ Desktop");
    
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number
            });
    
            const existing = comments.find(c =>
              c.user.type === "Bot" &&
              c.body.includes("ðŸš¦ Lighthouse Results")
            );
    
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body
              });
            }